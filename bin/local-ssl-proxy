#!/usr/bin/env node

const fs = require('fs');
const proxy = require('http-proxy');
const chalk = require('chalk');
const commandline = require('../dist/commandline');

const args = commandline.parse();

const config = args.config || { proxy: args };

Object.keys(config).forEach(function(name) {
  const options = config[name];
  const hostname = options.hostname || args.hostname;
  const target = options.target || args.target;
  const key = options.key || args.key;
  const cert = options.cert || args.cert;
  const source = options.source || args.source;

  proxy.createServer({
    xfwd: true,
    ws: true,
    target: {
      host: hostname,
      port: target
    },
    ssl: {
      key: fs.readFileSync(key, "utf8"),
      cert: fs.readFileSync(cert, "utf8")
    }
  }).on("error", function(e) {
    console.error(chalk.red("Request failed to " + name + ": " + chalk.bold(e.code)));
  }).listen(source);

  console.log(chalk.green("Started " + chalk.bold(name) + ": https://" + hostname + ":" + source, "â†’ http://" + hostname + ":" + target));
});
